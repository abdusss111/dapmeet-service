name: Deploy & (Optional) Migrate

on:
  push:
    branches: [ main ]

jobs:
  # ----------------------------------------------------------------
  # 1) Decide whether we need to run migrations
  # ----------------------------------------------------------------
  determine:
    runs-on: ubuntu-latest
    outputs:
      run_migrations: ${{ steps.flag-check.outputs.run-migrations }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check for [migrate] flag
        id: flag-check
        run: |
          # use GH's built‑in event data instead of raw `git log`
          MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $MSG"
          if [[ $MSG == *"[migrate]"* ]]; then
            echo "::set-output name=run-migrations::true"
          else
            echo "::set-output name=run-migrations::false"
          fi

  # ----------------------------------------------------------------
  # 2) Deploy—and, if needed, run Alembic inside the Docker container
  # ----------------------------------------------------------------
  deploy:
    needs: determine
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            cd ~/service
            git pull origin main
            docker-compose down

            if [ "${{ needs.determine.outputs.run_migrations }}" = "true" ]; then
              echo "=== [migrate] → Running Alembic migrations inside container ==="
              # this ensures the same environment as your app:
              docker-compose run --rm web alembic upgrade head
            else
              echo "=== No [migrate] flag → Skipping Alembic migrations ==="
            fi

            docker-compose up --build -d
